<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="MS Planner Quick Add - ‡∏™‡∏£‡πâ‡∏≤‡∏á Task ‡πÉ‡∏ô Microsoft Planner ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß">
  <title>MS Planner Quick Add</title>
  <script src="https://alcdn.msauth.net/browser/2.32.1/js/msal-browser.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìã</text></svg>">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="app" class="container mx-auto p-6 max-w-4xl">
    
    <!-- Info Banner -->
    <div class="bg-blue-600 text-white rounded-lg p-4 mb-6 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="font-bold text-lg mb-1">üìã MS Planner Quick Add</h2>
          <p class="text-sm opacity-90">‡∏™‡∏£‡πâ‡∏≤‡∏á Task ‡πÉ‡∏ô Microsoft Planner ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß</p>
        </div>
        <button onclick="toggleInfo()" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 text-sm font-medium">
          ‚ÑπÔ∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        </button>
      </div>
    </div>

    <!-- How to Use Section -->
    <div id="infoSection" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
      <h3 class="text-xl font-bold text-gray-900 mb-4">üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
      <div class="space-y-3 text-sm text-gray-700">
        <div class="flex items-start">
          <span class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center font-bold text-blue-600 mr-3">1</span>
          <div>
            <p class="font-medium">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</p>
            <p class="text-gray-600 mt-1">‡∏Ñ‡∏•‡∏¥‡∏Å "‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‚Üí ‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Azure AD App ‚Üí ‡πÉ‡∏™‡πà Client ID</p>
          </div>
        </div>
        <div class="flex items-start">
          <span class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center font-bold text-blue-600 mr-3">2</span>
          <div>
            <p class="font-medium">Login ‡∏î‡πâ‡∏ß‡∏¢ Microsoft Account</p>
            <p class="text-gray-600 mt-1">‡∏Ñ‡∏•‡∏¥‡∏Å "Login with Microsoft" ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Planner</p>
          </div>
        </div>
        <div class="flex items-start">
          <span class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center font-bold text-blue-600 mr-3">3</span>
          <div>
            <p class="font-medium">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Task</p>
            <p class="text-gray-600 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plan ‡πÅ‡∏•‡∏∞ Bucket ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á Task!</p>
          </div>
        </div>
      </div>
      
      <div class="mt-4 pt-4 border-t border-gray-200">
        <p class="text-xs text-gray-500">
          üí° <strong>Tips:</strong> ‡πÉ‡∏ä‡πâ Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ö‡πà‡∏≠‡∏¢‡πÜ | ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢ Task ‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á & ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠"
        </p>
      </div>
    </div>

    <!-- Setup Instructions (Show if not configured) -->
    <div id="setupInstructions" class="bg-yellow-50 border-l-4 border-yellow-400 p-6 mb-6 rounded-lg">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold text-yellow-900">‚öôÔ∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</h2>
        <button onclick="hideSetup()" class="text-yellow-700 hover:text-yellow-900 text-sm">‚úï ‡∏ã‡πà‡∏≠‡∏ô</button>
      </div>
      
      <div class="space-y-3 text-sm">
        <div class="bg-white p-4 rounded-lg">
          <h3 class="font-bold text-gray-900 mb-2">1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Azure AD App (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 3-5 ‡∏ô‡∏≤‡∏ó‡∏µ)</h3>
          <ol class="list-decimal ml-5 space-y-1 text-gray-700">
            <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" class="text-blue-600 underline">Azure Portal - App Registrations</a></li>
            <li>‡∏Ñ‡∏•‡∏¥‡∏Å "New registration"</li>
            <li>‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠: <code class="bg-gray-200 px-2 py-1 rounded">Planner Quick Add</code></li>
            <li>Supported account types: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong>"Accounts in any organizational directory and personal Microsoft accounts"</strong></li>
            <li>Redirect URI:
              <ul class="ml-4 mt-1">
                <li>- Type: <strong>Single-page application (SPA)</strong> ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!</li>
                <li>- URL: <code class="bg-gray-200 px-2 py-1 rounded font-mono text-xs" id="currentUrl"></code> <button onclick="copyUrl()" class="text-blue-600 text-xs ml-1 hover:underline">üìã Copy</button></li>
              </ul>
            </li>
            <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Register"</li>
          </ol>
          <div class="mt-3 p-2 bg-blue-50 rounded border border-blue-200 text-xs">
            <strong>üí° ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡πÅ‡∏≠‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Redirect flow ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Popup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ nested popups
          </div>
        </div>
        
        <div class="bg-white p-4 rounded-lg">
          <h3 class="font-bold text-gray-900 mb-2">2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permissions</h3>
          <ol class="list-decimal ml-5 space-y-1 text-gray-700">
            <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà "API permissions" ‚Üí "Add permission"</li>
            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Microsoft Graph" ‚Üí "Delegated permissions"</li>
            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: 
              <code class="bg-gray-200 px-1 rounded">User.Read</code>, 
              <code class="bg-gray-200 px-1 rounded">Group.ReadWrite.All</code>, 
              <code class="bg-gray-200 px-1 rounded">Tasks.ReadWrite</code>
            </li>
            <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Add permissions"</li>
          </ol>
        </div>
        
        <div class="bg-white p-4 rounded-lg">
          <h3 class="font-bold text-gray-900 mb-2">3. Copy Application (client) ID</h3>
          <ol class="list-decimal ml-5 space-y-1 text-gray-700">
            <li>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà "Overview"</li>
            <li>Copy <strong>Application (client) ID</strong></li>
            <li>‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‚Üì</li>
          </ol>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-300">
          <label class="block font-bold text-gray-900 mb-2">üìù ‡πÉ‡∏™‡πà Client ID ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà:</label>
          <div class="flex gap-2">
            <input 
              type="text" 
              id="clientIdInput" 
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
              placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
            >
            <button 
              onclick="saveClientId()" 
              class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-all"
            >
              üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
          </div>
          <p class="text-xs text-gray-600 mt-2">* Client ID ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ</p>
        </div>
      </div>
    </div>

    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">üìã MS Planner Quick Add</h1>
          <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á MS Planner ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ</p>
        </div>
        <div id="authSection">
          <button id="loginBtn" class="hidden px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md transition-all">
            üîê Login with Microsoft
          </button>
          <div id="userInfo" class="hidden text-right">
            <p class="text-sm text-gray-600">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß:</p>
            <p id="userName" class="font-medium text-gray-900"></p>
            <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-700 mt-1">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>
        </div>
      </div>
      
      <!-- Settings Button -->
      <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between">
        <button onclick="showSetup()" class="text-sm text-gray-600 hover:text-gray-900">
          ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ / ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Client ID
        </button>
        <a href="https://github.com/yourusername/ms-planner-quick-add" target="_blank" class="text-sm text-gray-600 hover:text-gray-900">
          <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          GitHub
        </a>
      </div>
    </div>

    <!-- Error Display -->
    <div id="errorDisplay" class="hidden bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded-lg">
      <div class="flex">
        <div class="flex-shrink-0">
          <span class="text-2xl">‚ùå</span>
        </div>
        <div class="ml-3 flex-1">
          <h3 class="text-sm font-medium text-red-800">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
          <div id="errorMessage" class="mt-2 text-sm text-red-700"></div>
          <div id="errorSolution" class="mt-3 text-sm text-red-600"></div>
        </div>
      </div>
    </div>

    <!-- Main Form -->
    <div id="mainForm" class="hidden">
      <!-- Plan Selection -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">1Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plan</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Plan</label>
            <select id="planSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Plans...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Bucket</label>
            <select id="bucketSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled>
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plan ‡∏Å‡πà‡∏≠‡∏ô</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Task Form -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-900">2Ô∏è‚É£ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Task</h2>
          <button id="loadTemplateBtn" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-medium">
            üìù ‡πÉ‡∏ä‡πâ Template
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠ Task *</label>
            <input type="text" id="taskTitle" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏°, ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...">
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
              <input type="date" id="startDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label>
              <input type="date" id="dueDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <label class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors border-gray-300 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                <input type="radio" name="priority" value="1" class="mr-2">
                <span class="text-sm">üü¢ Low</span>
              </label>
              <label class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors border-gray-300 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                <input type="radio" name="priority" value="5" checked class="mr-2">
                <span class="text-sm">üü° Medium</span>
              </label>
              <label class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors border-gray-300 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                <input type="radio" name="priority" value="9" class="mr-2">
                <span class="text-sm">üî¥ Important</span>
              </label>
              <label class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors border-gray-300 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                <input type="radio" name="priority" value="10" class="mr-2">
                <span class="text-sm">üî• Urgent</span>
              </label>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Progress</label>
            <select id="progress" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="0">Not Started</option>
              <option value="50">In Progress</option>
              <option value="100">Completed</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
            <textarea id="taskDescription" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
          </div>

          <div>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="saveAsTemplate" class="mr-2 w-4 h-4">
              <span class="text-sm text-gray-700">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô Template</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button id="createTaskBtn" class="px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-lg shadow-md transition-all">
            ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Task
          </button>
          <button id="createAndNewBtn" class="px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium text-lg shadow-md transition-all">
            ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á & ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠
          </button>
          <button id="clearFormBtn" class="px-6 py-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition-all">
            üîÑ Clear
          </button>
        </div>
      </div>

      <!-- Templates Section -->
      <div id="templatesSection" class="bg-white rounded-lg shadow-lg p-6 hidden">
        <h3 class="text-lg font-bold text-gray-900 mb-4">üìù Templates ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h3>
        <div id="templatesList" class="space-y-2"></div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-sm text-gray-500 mt-8 pb-4">
      <p>Made with ‚ù§Ô∏è for easier MS Planner task creation</p>
      <p class="mt-1">
        <a href="https://github.com/yourusername/ms-planner-quick-add" target="_blank" class="text-blue-600 hover:underline">View on GitHub</a>
        ‚Ä¢
        <a href="https://github.com/yourusername/ms-planner-quick-add/issues" target="_blank" class="text-blue-600 hover:underline">Report Issue</a>
      </p>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="hidden fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-lg text-white font-medium z-50"></div>
  </div>

  <!-- Template Modal -->
  <div id="templateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h3 class="text-xl font-bold text-gray-900 mb-4">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template</h3>
      <input type="text" id="templateName" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Template...">
      <div class="flex gap-3">
        <button id="saveTemplateBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="cancelTemplateBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <script>
    let msalInstance = null;
    let account = null;
    let accessToken = null;

    // Show current URL
    document.getElementById('currentUrl').textContent = window.location.origin + window.location.pathname;

    function toggleInfo() {
      const info = document.getElementById('infoSection');
      info.classList.toggle('hidden');
    }

    function copyUrl() {
      const url = window.location.origin + window.location.pathname;
      navigator.clipboard.writeText(url);
      showStatus('‚úÖ Copy URL ‡πÅ‡∏•‡πâ‡∏ß!', 'success');
    }

    function saveClientId() {
      const clientId = document.getElementById('clientIdInput').value.trim();
      
      // Validate format
      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      if (!uuidRegex.test(clientId)) {
        showError('Client ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx');
        return;
      }

      localStorage.setItem('msplanner_clientid', clientId);
      showStatus('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Client ID ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á reload...', 'success');
      
      setTimeout(() => {
        location.reload();
      }, 1000);
    }

    function showSetup() {
      document.getElementById('setupInstructions').classList.remove('hidden');
      const clientId = localStorage.getItem('msplanner_clientid') || '';
      document.getElementById('clientIdInput').value = clientId;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideSetup() {
      document.getElementById('setupInstructions').classList.add('hidden');
    }

    function showError(message, solution) {
      const errorDisplay = document.getElementById('errorDisplay');
      const errorMessage = document.getElementById('errorMessage');
      const errorSolution = document.getElementById('errorSolution');
      
      errorMessage.textContent = message;
      errorSolution.innerHTML = '<strong>üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</strong> ' + solution;
      errorDisplay.classList.remove('hidden');
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideError() {
      document.getElementById('errorDisplay').classList.add('hidden');
    }

    // Initialize
    async function init() {
      const clientId = localStorage.getItem('msplanner_clientid');
      
      if (!clientId) {
        // Show setup instructions
        document.getElementById('setupInstructions').classList.remove('hidden');
        return;
      }

      // Hide setup instructions
      hideSetup();

      // Initialize MSAL with dynamic redirect URI
      const msalConfig = {
        auth: {
          clientId: clientId,
          // Use /organizations for work/school accounts, or /common for multi-tenant
          // If you get AADSTS50194 error, change /common to /organizations
          authority: 'https://login.microsoftonline.com/organizations',
          redirectUri: window.location.origin + window.location.pathname
        },
        cache: {
          cacheLocation: 'localStorage',
          storeAuthStateInCookie: false
        }
      };

      const loginRequest = {
        scopes: ['User.Read', 'Group.ReadWrite.All', 'Tasks.ReadWrite']
      };

      try {
        msalInstance = new msal.PublicClientApplication(msalConfig);
        await msalInstance.initialize();
        
        // Handle redirect response
        const response = await msalInstance.handleRedirectPromise();
        if (response) {
          account = response.account;
          await getAccessToken();
          showUserInfo();
          await loadPlans();
          loadTemplates();
        } else {
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length > 0) {
            account = accounts[0];
            await getAccessToken();
            showUserInfo();
            await loadPlans();
            loadTemplates();
          } else {
            document.getElementById('loginBtn').classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Init error:', error);
        handleAuthError(error);
      }
    }

    // Login
    document.getElementById('loginBtn').addEventListener('click', async () => {
      try {
        hideError();
        // Use redirect flow instead of popup to avoid nested popup issues
        await msalInstance.loginRedirect({
          scopes: ['User.Read', 'Group.ReadWrite.All', 'Tasks.ReadWrite']
        });
      } catch (error) {
        console.error('Login error:', error);
        handleAuthError(error);
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (msalInstance) {
        msalInstance.logoutRedirect();
      }
    });

    // Get Access Token
    async function getAccessToken() {
      try {
        const response = await msalInstance.acquireTokenSilent({
          scopes: ['User.Read', 'Group.ReadWrite.All', 'Tasks.ReadWrite'],
          account: account
        });
        accessToken = response.accessToken;
        hideError();
      } catch (error) {
        console.error('Token error:', error);
        // If silent token acquisition fails, use redirect
        await msalInstance.acquireTokenRedirect({
          scopes: ['User.Read', 'Group.ReadWrite.All', 'Tasks.ReadWrite']
        });
      }
    }

    // Handle Auth Errors
    function handleAuthError(error) {
      let message = error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
      let solution = '';

      if (error.errorCode === 'invalid_client' || message.includes('AADSTS700016')) {
        solution = 'Client ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Client ID ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ <button onclick="showSetup()" class="underline text-blue-600">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</button>';
      } else if (message.includes('redirect_uri') || message.includes('AADSTS50011')) {
        solution = `Redirect URI ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô Azure AD ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô: <code class="bg-gray-200 px-2 py-1">${window.location.origin}${window.location.pathname}</code>`;
      } else if (message.includes('consent')) {
        solution = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Grant permissions ‡πÉ‡∏ô Azure AD ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Grant admin consent';
      } else if (error.errorCode === 'user_cancelled') {
        solution = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£ login';
        return; // Don't show error for cancelled login
      } else {
        solution = '‡∏•‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå cache ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå';
      }

      showError(message, solution);
    }

    // Show User Info
    function showUserInfo() {
      document.getElementById('loginBtn').classList.add('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('userName').textContent = account.name || account.username;
      document.getElementById('mainForm').classList.remove('hidden');
    }

    // Load Plans
    async function loadPlans() {
      try {
        const response = await fetch('https://graph.microsoft.com/v1.0/me/planner/plans', {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        const planSelect = document.getElementById('planSelect');
        planSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plan...</option>';
        
        if (data.value.length === 0) {
          planSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö Plan (‡∏™‡∏£‡πâ‡∏≤‡∏á Plan ‡πÉ‡∏ô MS Planner ‡∏Å‡πà‡∏≠‡∏ô)</option>';
          showStatus('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Plan ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Plan ‡πÉ‡∏ô MS Planner ‡∏Å‡πà‡∏≠‡∏ô', 'error');
        } else {
          data.value.forEach(plan => {
            const option = document.createElement('option');
            option.value = plan.id;
            option.textContent = plan.title;
            planSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Load plans error:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Plans: ' + error.message, 
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Permissions ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (User.Read, Group.ReadWrite.All, Tasks.ReadWrite)');
      }
    }

    // Load Buckets
    document.getElementById('planSelect').addEventListener('change', async (e) => {
      const planId = e.target.value;
      const bucketSelect = document.getElementById('bucketSelect');
      
      if (!planId) {
        bucketSelect.disabled = true;
        bucketSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plan ‡∏Å‡πà‡∏≠‡∏ô</option>';
        return;
      }

      try {
        const response = await fetch(`https://graph.microsoft.com/v1.0/planner/plans/${planId}/buckets`, {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        bucketSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Bucket...</option>';
        bucketSelect.disabled = false;
        
        data.value.forEach(bucket => {
          const option = document.createElement('option');
          option.value = bucket.id;
          option.textContent = bucket.name;
          bucketSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Load buckets error:', error);
        showStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Buckets: ' + error.message, 'error');
      }
    });

    // Create Task
    async function createTask(clearAfter = false) {
      const planId = document.getElementById('planSelect').value;
      const bucketId = document.getElementById('bucketSelect').value;
      const title = document.getElementById('taskTitle').value.trim();
      
      if (!planId || !bucketId || !title) {
        showStatus('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }

      const priority = parseInt(document.querySelector('input[name="priority"]:checked').value);
      const percentComplete = parseInt(document.getElementById('progress').value);
      
      const taskData = {
        planId: planId,
        bucketId: bucketId,
        title: title,
        priority: priority,
        percentComplete: percentComplete
      };

      // Add optional fields
      const startDate = document.getElementById('startDate').value;
      const dueDate = document.getElementById('dueDate').value;
      const description = document.getElementById('taskDescription').value.trim();

      if (startDate) taskData.startDateTime = new Date(startDate + 'T00:00:00').toISOString();
      if (dueDate) taskData.dueDateTime = new Date(dueDate + 'T23:59:59').toISOString();

      try {
        // Create task
        const response = await fetch('https://graph.microsoft.com/v1.0/planner/tasks', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(taskData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || `HTTP ${response.status}`);
        }
        
        const task = await response.json();

        // Add description if provided
        if (description) {
          try {
            await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${task.id}/details`, {
              method: 'PATCH',
              headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
                'If-Match': task['@odata.etag']
              },
              body: JSON.stringify({ 
                description: description,
                previewType: 'description'
              })
            });
          } catch (descError) {
            console.warn('Could not add description:', descError);
          }
        }

        showStatus('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Task ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

        // Save as template if checked
        if (document.getElementById('saveAsTemplate').checked) {
          showTemplateModal();
        }

        if (clearAfter) {
          clearForm();
        }
      } catch (error) {
        console.error('Create task error:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Task: ' + error.message,
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ permission Tasks.ReadWrite ‡πÅ‡∏•‡∏∞ Group.ReadWrite.All');
      }
    }

    // Event Listeners
    document.getElementById('createTaskBtn').addEventListener('click', () => createTask(false));
    document.getElementById('createAndNewBtn').addEventListener('click', () => createTask(true));
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);

    // Clear Form
    function clearForm() {
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskDescription').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('dueDate').value = '';
      document.getElementById('progress').value = '0';
      document.querySelector('input[name="priority"][value="5"]').checked = true;
      document.getElementById('saveAsTemplate').checked = false;
      document.getElementById('taskTitle').focus();
    }

    // Templates
    function loadTemplates() {
      const templates = JSON.parse(localStorage.getItem('plannerTemplates') || '[]');
      const templatesList = document.getElementById('templatesList');
      const templatesSection = document.getElementById('templatesSection');
      
      if (templates.length > 0) {
        templatesSection.classList.remove('hidden');
        templatesList.innerHTML = templates.map((template, index) => `
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
            <button onclick="applyTemplate(${index})" class="flex-1 text-left font-medium text-gray-900">
              ${template.name}
            </button>
            <button onclick="deleteTemplate(${index})" class="text-red-600 hover:text-red-700 ml-2 px-3 py-1">üóëÔ∏è</button>
          </div>
        `).join('');
      }
    }

    function showTemplateModal() {
      document.getElementById('templateModal').classList.remove('hidden');
      document.getElementById('templateName').focus();
    }

    document.getElementById('loadTemplateBtn').addEventListener('click', () => {
      const templates = JSON.parse(localStorage.getItem('plannerTemplates') || '[]');
      if (templates.length === 0) {
        showStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Template', 'error');
      } else {
        document.getElementById('templatesSection').scrollIntoView({ behavior: 'smooth' });
      }
    });

    document.getElementById('saveTemplateBtn').addEventListener('click', () => {
      const name = document.getElementById('templateName').value.trim();
      if (!name) {
        showStatus('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ Template', 'error');
        return;
      }

      const template = {
        name: name,
        data: {
          title: document.getElementById('taskTitle').value,
          description: document.getElementById('taskDescription').value,
          priority: document.querySelector('input[name="priority"]:checked').value,
          progress: document.getElementById('progress').value
        }
      };

      const templates = JSON.parse(localStorage.getItem('plannerTemplates') || '[]');
      templates.push(template);
      localStorage.setItem('plannerTemplates', JSON.stringify(templates));

      document.getElementById('templateModal').classList.add('hidden');
      document.getElementById('templateName').value = '';
      loadTemplates();
      showStatus('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    });

    document.getElementById('cancelTemplateBtn').addEventListener('click', () => {
      document.getElementById('templateModal').classList.add('hidden');
      document.getElementById('templateName').value = '';
    });

    function applyTemplate(index) {
      const templates = JSON.parse(localStorage.getItem('plannerTemplates') || '[]');
      const template = templates[index];
      
      document.getElementById('taskTitle').value = template.data.title;
      document.getElementById('taskDescription').value = template.data.description;
      document.getElementById('progress').value = template.data.progress;
      document.querySelector(`input[name="priority"][value="${template.data.priority}"]`).checked = true;
      
      showStatus('üìù ‡πÉ‡∏ä‡πâ Template: ' + template.name, 'success');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteTemplate(index) {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Template ‡∏ô‡∏µ‡πâ?')) return;
      
      const templates = JSON.parse(localStorage.getItem('plannerTemplates') || '[]');
      templates.splice(index, 1);
      localStorage.setItem('plannerTemplates', JSON.stringify(templates));
      loadTemplates();
      showStatus('üóëÔ∏è ‡∏•‡∏ö Template ‡πÅ‡∏•‡πâ‡∏ß', 'success');
    }

    // Show Status
    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-lg text-white font-medium z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
      }`;
      statusEl.classList.remove('hidden');
      
      setTimeout(() => {
        statusEl.classList.add('hidden');
      }, 3000);
    }

    // Initialize app
    init();
  </script>
</body>
</html>